// script.js
window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

const translations = {
  "en-IN": {
    title: "ЁЯОЩя╕П Multi-language Voice to Text",
    instruction: "Real-time speech transcription for improved accessibility.",
    start: "тЦ╢я╕П Start Listening",
    stop: "тП╣я╕П Stop",
    selectLabel: "Select Language:",
    placeholder: "Speech output will appear here...",
    download: "тмЗя╕П Download Transcript"
  },
  "hi-IN": {
    title: "ЁЯОЩя╕П рдмрд╣реБрднрд╛рд╖реА рд╡реЙрдпрд╕ рдЯреВ рдЯреЗрдХреНрд╕реНрдЯ",
    instruction: "рдмреЗрд╣рддрд░ рдкрд╣реБрдВрдЪ рдХреЗ рд▓рд┐рдП рд░реАрдпрд▓-рдЯрд╛рдЗрдо рднрд╛рд╖рдг рдЯреНрд░рд╛рдВрд╕рдХреНрд░рд┐рдкреНрд╢рдиред",
    start: "тЦ╢я╕П рд╕реБрдирдирд╛ рдкреНрд░рд╛рд░рдВрдн рдХрд░реЗрдВ",
    stop: "тП╣я╕П рд░реЛрдХреЗрдВ",
    selectLabel: "рднрд╛рд╖рд╛ рдЪреБрдиреЗрдВ:",
    placeholder: "рдпрд╣рд╛рдБ рднрд╛рд╖рдг рдЖрдЙрдЯрдкреБрдЯ рджрд┐рдЦрд╛рдИ рджреЗрдЧрд╛...",
    download: "тмЗя╕П рдЯреНрд░рд╛рдВрд╕рдХреНрд░рд┐рдкреНрдЯ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВ"
  },
  "mr-IN": {
    title: "ЁЯОЩя╕П рдмрд╣реБрднрд╛рд╖рд┐рдХ рдЖрд╡рд╛рдЬ рддреЗ рдордЬрдХреВрд░",
    instruction: "рд╕реБрд▓рднрддреЗрд╕рд╛рдареА рд░рд┐рдЕрд▓-рдЯрд╛рдЗрдо рднрд╛рд╖рд╛рдВрддрд░.",
    start: "тЦ╢я╕П рдРрдХрдгреЗ рд╕реБрд░реВ рдХрд░рд╛",
    stop: "тП╣я╕П рдерд╛рдВрдмрд╛",
    selectLabel: "рднрд╛рд╖рд╛ рдирд┐рд╡рдбрд╛:",
    placeholder: "рдЗрдереЗ рднрд╛рд╖рдгрд╛рдЪрд╛ рдордЬрдХреВрд░ рджрд┐рд╕реЗрд▓...",
    download: "тмЗя╕П рдЯреНрд░рд╛рдиреНрд╕рдХреНрд░рд┐рдкреНрдЯ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рд╛"
  },
  "te-IN": {
    title: "ЁЯОЩя╕П р░мр░╣р▒Бр░нр░╛р░╖р░╛ р░╡р░╛р░пр░┐р░╕р▒Н р░Яр▒Б р░Яр▒Жр░Хр▒Нр░╕р▒Нр░Яр▒Н",
    instruction: "р░Ер░Вр░жр▒Бр░мр░╛р░Яр▒Бр░▓р▒Л р░ор▒Жр░░р▒Бр░Чр▒Бр░жр░▓ р░Хр▒Лр░╕р░В р░ир░┐р░Ь р░╕р░ор░п р░кр▒Нр░░р░╕р░Вр░Ч р░Яр▒Нр░░р░╛р░ир▒Нр░╕р▒Нр░Хр▒Нр░░р░┐р░кр▒Нр░╖р░ир▒Н.",
    start: "тЦ╢я╕П р░╡р░┐р░ир░бр░В р░кр▒Нр░░р░╛р░░р░Вр░нр░┐р░Вр░Ър░Вр░бр░┐",
    stop: "тП╣я╕П р░Жр░кр▒Б",
    selectLabel: "р░нр░╛р░╖р░ир▒Б р░Ор░Вр░Ър▒Бр░Хр▒Лр░Вр░бр░┐:",
    placeholder: "р░Зр░Хр▒Нр░Хр░б р░ор▒А р░ор░╛р░Яр░▓ р░Ър▒Жр░Хр▒Нр░╕р▒Нр░Яр▒Н р░Хр░ир░┐р░кр░┐р░╕р▒Нр░др▒Бр░Вр░жр░┐...",
    download: "тмЗя╕П р░Яр▒Нр░░р░╛р░ир▒Нр░╕р▒Нр░Хр▒Нр░░р░┐р░кр▒Нр░Яр▒Н р░бр▒Мр░ир▒Нр░▓р▒Лр░бр▒Н р░Ър▒Зр░пр░Вр░бр░┐"
  },
  "ta-IN": {
    title: "ЁЯОЩя╕П рокро▓роорпКро┤ро┐ роХрпБро░ро▓рпБроХрпНроХрпБ роЙро░рпИ",
    instruction: "роЕройрпИро╡ро░рпБроХрпНроХрпБроорпН рокропройрпНрокроЯрпБроорпН ро╡роХрпИропро┐ро▓рпН роирпЗро░роЯро┐ роХрпБро░ро▓рпН роЙро░рпИ рооро╛ро▒рпНро▒роорпН.",
    start: "тЦ╢я╕П роХрпЗроЯрпНроХродрпН родрпКроЯроЩрпНроХрпБ",
    stop: "тП╣я╕П роиро┐ро▒рпБродрпНродрпБ",
    selectLabel: "роорпКро┤ро┐ропрпИ родрпЗро░рпНро╡рпБроЪрпЖропрпНроХ:",
    placeholder: "роЙроЩрпНроХро│рпН рокрпЗроЪрпНроЪрпБ роЗроЩрпНроХрпЗ родрпЛройрпНро▒рпБроорпН...",
    download: "тмЗя╕П роЙро░рпИропрпИ рокродро┐ро╡ро┐ро▒роХрпНроХрпБроХ"
  },
  "kn-IN": {
    title: "ЁЯОЩя╕П р▓мр▓╣р│Бр▓нр▓╛р▓╖р▓╛ р▓зр│Нр▓╡р▓ир▓┐ р▓кр▓ар│Нр▓п",
    instruction: "р▓╕р│Бр▓зр▓╛р▓░р▓┐р▓д р▓кр│Нр▓░р▓╛р▓кр│Нр▓пр▓др│Жр▓пр▓┐р▓Чр▓╛р▓Чр▓┐ р▓░р▓┐р▓пр▓▓р│Н р▓Яр│Ир▓ор│Н р▓╕р│Нр▓кр│Ар▓Ър│Н р▓Яр│Нр▓░р▓╛р▓ир│Нр▓╕р│Нр▓Хр│Нр▓░р▓┐р▓кр│Нр▓╖р▓ир│Н.",
    start: "тЦ╢я╕П р▓Хр│Зр▓│р▓▓р│Б р▓кр│Нр▓░р▓╛р▓░р▓Вр▓нр▓┐р▓╕р▓┐",
    stop: "тП╣я╕П р▓ир▓┐р▓▓р│Нр▓▓р▓┐р▓╕р▓┐",
    selectLabel: "р▓нр▓╛р▓╖р│Жр▓пр▓ир│Нр▓ир│Б р▓Жр▓пр│Нр▓Хр│Жр▓ор▓╛р▓бр▓┐:",
    placeholder: "р▓Зр▓▓р│Нр▓▓р▓┐ р▓ир▓┐р▓ор│Нр▓о р▓ор▓╛р▓др▓┐р▓и р▓кр▓ар│Нр▓п р▓Хр▓╛р▓гр│Бр▓др│Нр▓др▓жр│Ж...",
    download: "тмЗя╕П р▓кр│Нр▓░р▓др▓┐р▓пр▓ир│Нр▓ир│Б р▓бр│Мр▓ир│НтАМр▓▓р│Лр▓бр│Н р▓ор▓╛р▓бр▓┐"
  },
  "bn-IN": {
    title: "ЁЯОЩя╕П ржмрж╣рзБржнрж╛рж╖рж┐ржХ ржнржпрж╝рзЗрж╕ ржЯрзБ ржЯрзЗржХрзНрж╕ржЯ",
    instruction: "ржЙржирзНржиржд ржкрзНрж░ржмрзЗрж╢ржпрзЛржЧрзНржпрждрж╛рж░ ржЬржирзНржп рж░рж┐ржпрж╝рзЗрж▓-ржЯрж╛ржЗржо ржмржХрзНрждрзГрждрж╛ ржкрзНрж░рждрж┐рж▓рж┐ржкрж┐ред",
    start: "тЦ╢я╕П рж╢рзЛржирж╛ рж╢рзБрж░рзБ ржХрж░рзБржи",
    stop: "тП╣я╕П ржерж╛ржорж╛ржи",
    selectLabel: "ржнрж╛рж╖рж╛ ржирж┐рж░рзНржмрж╛ржЪржи ржХрж░рзБржи:",
    placeholder: "ржЖржкржирж╛рж░ ржмржХрзНрждрзГрждрж╛ ржПржЦрж╛ржирзЗ ржжрзЗржЦрж╛ ржпрж╛ржмрзЗ...",
    download: "тмЗя╕П ржЯрзНрж░рж╛ржирзНрж╕ржХрзНрж░рж┐ржкрзНржЯ ржбрж╛ржЙржирж▓рзЛржб ржХрж░рзБржи"
  },
  "gu-IN": {
    title: "ЁЯОЩя╕П ркмрк╣рлБркнрк╛рк╖рлА ркЕрк╡рк╛ркЬ ркерлА рк▓ркЦрк╛ркг",
    instruction: "рк╕рлБркзрк╛рк░рлЗрк▓рлА ркНркХрлНрк╕рлЗрк╕рк┐ркмрк┐рк▓рк┐ркЯрлА ркорк╛ркЯрлЗ рк░рк┐ркпрк▓-ркЯрк╛ркИрко рк╕рлНрккрлАркЪ ркЯрлНрк░рк╛ркирлНрк╕ркХрлНрк░рк┐рккрлНрк╢рки.",
    start: "тЦ╢я╕П рк╕рк╛ркВркнрк│рк╡рк╛ркирлБркВ рк╢рк░рлВ ркХрк░рлЛ",
    stop: "тП╣я╕П ркмркВркз ркХрк░рлЛ",
    selectLabel: "ркнрк╛рк╖рк╛ рккрк╕ркВркж ркХрк░рлЛ:",
    placeholder: "ркЕрк╣рлАркВ ркдркорк╛рк░рлБркВ ркнрк╛рк╖ркг ркжрлЗркЦрк╛рк╢рлЗ...",
    download: "тмЗя╕П ркЯрлНрк░рк╛ркирлНрк╕ркХрлНрк░рк┐рккрлНркЯ ркбрк╛ркЙркирк▓рлЛркб ркХрк░рлЛ"
  },
  "ml-IN": {
    title: "ЁЯОЩя╕П р┤мр┤╣р╡Бр┤нр┤╛р┤╖р┤╛ р┤╡р╡Лр┤пр┤┐р┤╕р╡Н р┤Яр╡Б р┤Яр╡Жр┤Хр╡Нр┤╕р╡Нр┤▒р╡Нр┤▒р╡Н",
    instruction: "р┤ор╡Жр┤Ър╡Нр┤Ър┤кр╡Нр┤кр╡Жр┤Яр╡Нр┤Я р┤Жр┤Хр╡Нр┤╕р┤╕р┤┐р┤мр┤┐р┤▓р┤┐р┤▒р╡Нр┤▒р┤┐р┤Хр╡Нр┤Хр╡Н р┤▒р┤┐р┤пр╡╜-р┤Яр╡Ир┤В р┤╕р╡Нр┤кр╡Ар┤Ър╡Нр┤Ър╡Н р┤Яр╡Нр┤░р┤╛р╡╗р┤╕р╡Нр┤Хр╡Нр┤░р┤┐р┤кр╡Нр┤╖р╡╗.",
    start: "тЦ╢я╕П р┤Хр╡Зр╡╛р┤Хр╡Нр┤Хр┤╛р╡╗ р┤др╡Бр┤Яр┤Щр╡Нр┤Щр╡Бр┤Х",
    stop: "тП╣я╕П р┤ир┤┐р╡╝р┤др╡Нр┤др╡Бр┤Х",
    selectLabel: "р┤нр┤╛р┤╖ р┤др┤┐р┤░р┤Юр╡Нр┤Юр╡Жр┤Яр╡Бр┤Хр╡Нр┤Хр╡Бр┤Х:",
    placeholder: "р┤ир┤┐р┤Щр╡Нр┤Щр┤│р╡Бр┤Яр╡Ж р┤╡р┤╛р┤Хр╡Нр┤Хр╡Бр┤Хр╡╛ р┤Зр┤╡р┤┐р┤Яр╡Ж р┤кр╡Нр┤░р┤др╡Нр┤пр┤Хр╡Нр┤╖р┤кр╡Нр┤кр╡Жр┤Яр╡Бр┤В...",
    download: "тмЗя╕П р┤Яр╡Нр┤░р┤╛р╡╗р┤╕р╡Нр┤Хр╡Нр┤░р┤┐р┤кр╡Нр┤▒р╡Нр┤▒р╡Н р┤бр╡Чр╡║р┤▓р╡Лр┤бр╡Н р┤Ър╡Жр┤пр╡Нр┤пр╡Бр┤Х"
  },
  "pa-IN": {
    title: "ЁЯОЩя╕П римри╣рйБринри╛ри╕ри╝рйА ри╡ри╛риЗри╕ ридрйЛриВ риЯрйИриХри╕риЯ",
    instruction: "ри╡ризрйАриЖ рикри╣рйБрй░риЪ ри▓риИ риЕри╕ри▓ ри╕риорйЗриВ рижрйА ри╡ри╛ригрйА риЯрйНри░ри╛риВри╕риХрйНри░ри┐рикри╕ри╝рии.",
    start: "тЦ╢я╕П ри╕рйБригриири╛ ри╕ри╝рйБри░рйВ риХри░рйЛ",
    stop: "тП╣я╕П ри░рйЛриХрйЛ",
    selectLabel: "ринри╛ри╕ри╝ри╛ риЪрйБригрйЛ:",
    placeholder: "ридрйБри╣ри╛рибрйА ри╡ри╛ригрйА риЗрй▒риерйЗ рикрйНри░риЧриЯ ри╣рйЛриПриЧрйА...",
    download: "тмЗя╕П риЯрйНри░ри╛риВри╕риХрйНри░ри┐рикриЯ рибри╛риКриири▓рйЛриб риХри░рйЛ"
  },
  "ur-IN": {
    title: "ЁЯОЩя╕П ┌й╪л█М╪▒ ┘Д╪│╪з┘Ж█М ╪в┘И╪з╪▓ ╪│█Т ┘Е╪к┘Ж",
    instruction: "╪и█Б╪к╪▒ ╪▒╪│╪з╪ж█М ┌й█Т ┘Д█М█Т ╪з╪╡┘Д ┘И┘В╪к ┌й█М ╪к┘В╪▒█М╪▒ ┌й█М ╪к╪н╪▒█М╪▒█Ф",
    start: "тЦ╢я╕П ╪│┘Ж┘Ж╪з ╪┤╪▒┘И╪╣ ┌й╪▒█М┌║",
    stop: "тП╣я╕П ╪▒┘И┌й█М┌║",
    selectLabel: "╪▓╪и╪з┘Ж ┘Е┘Ж╪к╪о╪и ┌й╪▒█М┌║:",
    placeholder: "╪в┘╛ ┌й█М ╪к┘В╪▒█М╪▒ █М█Б╪з┌║ ╪╕╪з█Б╪▒ █Б┘И┌п█М...",
    download: "тмЗя╕П ┘╣╪▒╪з┘Ж╪│┌й╪▒┘╛┘╣ ┌И╪з╪д┘Ж ┘Д┘И┌И ┌й╪▒█М┌║"
  },
  "es-ES": {
    title: "ЁЯОЩя╕П Voz a texto multiling├╝e",
    instruction: "Transcripci├│n de voz en tiempo real para una mejor accesibilidad.",
    start: "тЦ╢я╕П Comenzar a escuchar",
    stop: "тП╣я╕П Detener",
    selectLabel: "Seleccionar idioma:",
    placeholder: "El texto del discurso aparecer├б aqu├н...",
    download: "тмЗя╕П Descargar transcripci├│n"
  },
  "fr-FR": {
    title: "ЁЯОЩя╕П Voix multilingue vers texte",
    instruction: "Transcription vocale en temps r├йel pour une meilleure accessibilit├й.",
    start: "тЦ╢я╕П Commencer ├а ├йcouter",
    stop: "тП╣я╕П Arr├кter",
    selectLabel: "Choisir la langue:",
    placeholder: "Le texte du discours appara├оtra ici...",
    download: "тмЗя╕П T├йl├йcharger la transcription"
  },
  "de-DE": {
    title: "ЁЯОЩя╕П Mehrsprachige Sprache zu Text",
    instruction: "Echtzeit-Sprachtranskription f├╝r bessere Zug├дnglichkeit.",
    start: "тЦ╢я╕П Zuh├╢ren starten",
    stop: "тП╣я╕П Stoppen",
    selectLabel: "Sprache ausw├дhlen:",
    placeholder: "Die Sprachausgabe erscheint hier...",
    download: "тмЗя╕П Transkript herunterladen"
  },
  "ru-RU": {
    title: "ЁЯОЩя╕П ╨Ь╨╜╨╛╨│╨╛╤П╨╖╤Л╤З╨╜╤Л╨╣ ╨│╨╛╨╗╨╛╤Б ╨▓ ╤В╨╡╨║╤Б╤В",
    instruction: "╨Я╤А╨╡╨╛╨▒╤А╨░╨╖╨╛╨▓╨░╨╜╨╕╨╡ ╤А╨╡╤З╨╕ ╨▓ ╤В╨╡╨║╤Б╤В ╨▓ ╤А╨╡╨░╨╗╤М╨╜╨╛╨╝ ╨▓╤А╨╡╨╝╨╡╨╜╨╕ ╨┤╨╗╤П ╤Г╨╗╤Г╤З╤И╨╡╨╜╨╜╨╛╨╣ ╨┤╨╛╤Б╤В╤Г╨┐╨╜╨╛╤Б╤В╨╕.",
    start: "тЦ╢я╕П ╨Э╨░╤З╨░╤В╤М ╨┐╤А╨╛╤Б╨╗╤Г╤И╨╕╨▓╨░╨╜╨╕╨╡",
    stop: "тП╣я╕П ╨Ю╤Б╤В╨░╨╜╨╛╨▓╨╕╤В╤М",
    selectLabel: "╨Т╤Л╨▒╨╡╤А╨╕╤В╨╡ ╤П╨╖╤Л╨║:",
    placeholder: "╨Ч╨┤╨╡╤Б╤М ╨┐╨╛╤П╨▓╨╕╤В╤Б╤П ╤В╨╡╨║╤Б╤В ╨▓╨░╤И╨╡╨╣ ╤А╨╡╤З╨╕...",
    download: "тмЗя╕П ╨б╨║╨░╤З╨░╤В╤М ╤В╤А╨░╨╜╤Б╨║╤А╨╕╨┐╤В"
  },
  "ar-SA": {
    title: "ЁЯОЩя╕П ╪к╪н┘И┘К┘Д ╪з┘Д╪╡┘И╪к ┘Е╪к╪╣╪п╪п ╪з┘Д┘Д╪║╪з╪к ╪е┘Д┘Й ┘Ж╪╡",
    instruction: "┘Ж╪│╪о ╪з┘Д┘Г┘Д╪з┘Е ┘Б┘К ╪з┘Д┘И┘В╪к ╪з┘Д╪н┘В┘К┘В┘К ┘Д╪к╪н╪│┘К┘Ж ╪з┘Д┘И╪╡┘И┘Д.",
    start: "тЦ╢я╕П ╪з╪и╪п╪г ╪з┘Д╪з╪│╪к┘Е╪з╪╣",
    stop: "тП╣я╕П ╪к┘И┘В┘Б",
    selectLabel: "╪з╪о╪к╪▒ ╪з┘Д┘Д╪║╪й:",
    placeholder: "╪│┘К╪╕┘З╪▒ ┘Ж╪╡ ╪з┘Д┘Г┘Д╪з┘Е ┘З┘Ж╪з...",
    download: "тмЗя╕П ╪к┘Ж╪▓┘К┘Д ╪з┘Д┘Ж╪╡"
  },
  "ja-JP": {
    title: "ЁЯОЩя╕П хдЪшиАшкЮщЯ│хг░уБЛуВЙуГЖуВнуВ╣уГИуБ╕",
    instruction: "уВвуВпуВ╗уВ╖уГУуГкуГЖуВгхРСф╕КуБоуБЯуВБуБоуГкуВвуГлуВ┐уВдуГащЯ│хг░ш╗вхЖЩуАВ",
    start: "тЦ╢я╕П шБЮуБНхПЦуВКщЦЛхзЛ",
    stop: "тП╣я╕П хБЬцнв",
    selectLabel: "шиАшкЮуВТщБ╕цКЮ:",
    placeholder: "уБУуБУуБлщЯ│хг░уБоуГЖуВнуВ╣уГИуБМшбичд║уБХуВМуБ╛уБЩ...",
    download: "тмЗя╕П уГИуГйуГ│уВ╣уВпуГкуГЧуГИуВТуГАуВжуГ│уГнуГ╝уГЙ"
  },
  "zh-CN": {
    title: "ЁЯОЩя╕П хдЪшпншиАшпнщЯ│ш╜мцЦЗхнЧ",
    instruction: "ф╕║ф║ЖцЫ┤хе╜чЪДцЧащЪЬчвНшо┐щЧоя╝МхоЮцЧ╢шпнщЯ│ш╜мх╜ХуАВ",
    start: "тЦ╢я╕П х╝АхзЛшБЖхРм",
    stop: "тП╣я╕П хБЬцнв",
    selectLabel: "щАЙцЛйшпншиА:",
    placeholder: "шпнщЯ│цЦЗцЬмх░ЖцШ╛чд║хЬиш┐ЩщЗМ...",
    download: "тмЗя╕П ф╕Лш╜╜ш╜мх╜Х"
  },
  "ko-KR": {
    title: "ЁЯОЩя╕П ыЛдъ╡ньЦ┤ ьЭМьД▒ эЕНьКдэК╕ ы│АэЩШ",
    instruction: "ьаСъ╖╝ьД▒ьЭД ыЖТьЭ┤ъ╕░ ьЬДэХЬ ьЛдьЛЬъ░Д ьЭМьД▒ эХДъ╕░.",
    start: "тЦ╢я╕П ыУгъ╕░ ьЛЬьЮС",
    stop: "тП╣я╕П ьдСьзА",
    selectLabel: "ьЦ╕ьЦ┤ ьДаэГЭ:",
    placeholder: "ьЧмъ╕░ьЧР ьЭМьД▒ эЕНьКдэК╕ъ░А эСЬьЛЬыРйыЛИыЛд...",
    download: "тмЗя╕П эХДъ╕░ ыЛдьЪ┤ыбЬыУЬ"
  },
  "pt-PT": {
    title: "ЁЯОЩя╕П Voz para Texto Multil├нngue",
    instruction: "Transcri├з├гo de fala em tempo real para acessibilidade aprimorada.",
    start: "тЦ╢я╕П Come├зar a ouvir",
    stop: "тП╣я╕П Parar",
    selectLabel: "Selecionar idioma:",
    placeholder: "A sa├нda da fala aparecer├б aqui...",
    download: "тмЗя╕П Baixar Transcri├з├гo"
  }
};
if (!window.SpeechRecognition) {
  alert("Speech recognition is not supported in your browser. Please use Google Chrome.");
} else {
  const recognition = new SpeechRecognition();
  recognition.interimResults = true;
  recognition.continuous = true;

  const outputDiv = document.getElementById("output");
  const startBtn = document.getElementById("start-btn");
  const stopBtn = document.getElementById("stop-btn");
  const languageSelector = document.getElementById("language");
  const titleText = document.getElementById("title-text");
  const instructionText = document.getElementById("instruction-text");
  const placeholderText = document.getElementById("placeholder-text");
  const labelSelectLanguage = document.getElementById("label-select-language");
  const emotionText = document.getElementById("emotion-text");
  const downloadBtn = document.getElementById("download-btn");

  let finalTranscript = "";
  let paragraphBuffer = "";
  let isListening = false;
  let lastSpeechTime = Date.now();
  let lastEmotion = "";
  let lastEmotionTime = Date.now();
  let audioContext, analyser, microphone, dataArray;

  function updateLanguageUI(lang) {
    const t = translations[lang] || translations["en-IN"];
    titleText.textContent = t.title;
    instructionText.textContent = t.instruction;
    startBtn.textContent = t.start;
    stopBtn.textContent = t.stop;
    labelSelectLanguage.textContent = t.selectLabel;
    placeholderText.textContent = t.placeholder;
    downloadBtn.textContent = t.download;
  }

  function detectEmotion(volume, pitch) {
    if (volume > 0.7 && pitch > 250) return "ЁЯШа Angry";
    if (volume < 0.3 && pitch < 180) return "ЁЯШв Sad";
    if (pitch > 200 && volume < 0.5) return "ЁЯШК Happy";
    return "ЁЯШР Neutral";
  }

  function updateEmotionDisplay(emotion) {
    if (emotionText && emotion !== lastEmotion) {
      emotionText.textContent = emotion;
      lastEmotion = emotion;
      lastEmotionTime = Date.now();
    }
  }

  languageSelector.addEventListener("change", () => {
    const selectedLang = languageSelector.value;
    recognition.lang = selectedLang;
    updateLanguageUI(selectedLang);
  });

  recognition.onresult = (event) => {
    let interimTranscript = "";
    const now = Date.now();

    for (let i = event.resultIndex; i < event.results.length; i++) {
      const transcript = event.results[i][0].transcript.trim();
      if (event.results[i].isFinal) {
        if (now - lastSpeechTime > 1500) {
          finalTranscript += `\n\n${paragraphBuffer.trim()}`;
          paragraphBuffer = transcript + " ";
        } else {
          paragraphBuffer += transcript + " ";
        }
        lastSpeechTime = now;
      } else {
        interimTranscript += transcript + " ";
      }
    }

    outputDiv.innerHTML = `
      <p class="text-dark" style="white-space:pre-wrap;">${finalTranscript}\n\n${paragraphBuffer.trim()}</p>
      <p class="text-muted fst-italic">${interimTranscript}</p>
    `;
    outputDiv.scrollTop = outputDiv.scrollHeight;
  };

  recognition.onend = () => {
    if (isListening) recognition.start();
  };

  startBtn.addEventListener("click", async () => {
    if (!isListening) {
      try {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        analyser = audioContext.createAnalyser();
        dataArray = new Uint8Array(analyser.fftSize);

        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        microphone = audioContext.createMediaStreamSource(stream);
        microphone.connect(analyser);
        detectAudioEmotion();

        recognition.lang = languageSelector.value;
        recognition.start();
        isListening = true;
        startBtn.classList.add("disabled");
        stopBtn.classList.remove("disabled");
      } catch (err) {
        alert("Microphone access denied or unavailable.");
      }
    }
  });

  stopBtn.addEventListener("click", () => {
    if (isListening) {
      recognition.stop();
      isListening = false;
      startBtn.classList.remove("disabled");
      stopBtn.classList.add("disabled");
      updateEmotionDisplay("ЁЯШР Neutral");
    }
  });

  function detectAudioEmotion() {
    requestAnimationFrame(detectAudioEmotion);
    if (!analyser || !dataArray) return;
    analyser.getByteTimeDomainData(dataArray);

    let sum = 0;
    for (let i = 0; i < dataArray.length; i++) {
      let v = (dataArray[i] - 128) / 128;
      sum += v * v;
    }
    const volume = Math.sqrt(sum / dataArray.length);
    const pitch = Math.random() * 400 + 100;

    const emotion = detectEmotion(volume, pitch);

    if (volume > 0.02) {
      lastEmotionTime = Date.now();
      updateEmotionDisplay(emotion);
    } else {
      if (Date.now() - lastEmotionTime > 3000) {
        updateEmotionDisplay("ЁЯШР Neutral");
      }
    }
  }

  downloadBtn.addEventListener("click", () => {
    const text = `${finalTranscript}\n\n${paragraphBuffer.trim()}`.trim();
    if (!text) return;
    const blob = new Blob([text], { type: "text/plain" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "transcript.txt";
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  });

  updateLanguageUI(languageSelector.value);
}
